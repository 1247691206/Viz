!function(){var t={version:"1.0.0",template:{}};t.bP=function(){function t(i){m=i,i.each(function(){var i=d3.select(this),u=t.bars(),o=i.selectAll(".subBars").data(u.subBars).enter().append("g").attr("transform",function(t){return"translate("+t.x+","+t.y+")"}).attr("class","subBars").append("rect").attr("x",e).attr("y",r).attr("width",n).attr("height",a);"undefined"!=typeof p&&o.style("fill",function(t){return p(t)});var s=i.selectAll(".edges").data(u.edges).enter().append("path").attr("class","edges").attr("d",function(t){return t.path}).style("fill-opacity",t.edgeOpacity());"undefined"!=typeof p&&s.style("fill",function(t){return p(t)}),i.selectAll(".mainBars").data(u.mainBars).enter().append("g").attr("transform",function(t){return"translate("+t.x+","+t.y+")"}).attr("class","mainBars").append("rect").attr("x",e).attr("y",r).attr("width",n).attr("height",a).on("mouseover",t.mouseover).on("mouseout",t.mouseout)})}function e(t){return-t.width}function r(t){return-t.height}function n(t){return 2*t.width}function a(t){return 2*t.height}var i,u,o,s,c,d,y,l,f,h,p,m,g;return t.data=function(e){return arguments.length?(h=e,t):h},t.fill=function(e){return arguments.length?(p=e,t):p},t.keyPrimary=function(e){return arguments.length?(i=e,t):"undefined"!=typeof i?i:function(t){return t[0]}},t.keySecondary=function(e){return arguments.length?(u=e,t):"undefined"!=typeof u?u:function(t){return t[1]}},t.value=function(e){return arguments.length?(o=e,t):"undefined"!=typeof o?o:function(t){return t[2]}},t.width=function(e){return arguments.length?(s=e,t):"undefined"!=typeof s?s:400},t.height=function(e){return arguments.length?(c=e,t):"undefined"!=typeof c?c:600},t.barSize=function(e){return arguments.length?(y=e,t):"undefined"!=typeof y?y:35},t.min=function(e){return arguments.length?(l=e,t):"undefined"!=typeof l?l:0},t.orient=function(e){return arguments.length?(d=e,t):"undefined"!=typeof d?d:"vertical"},t.pad=function(e){return arguments.length?(f=e,t):"undefined"!=typeof f?f:0},t.duration=function(e){return arguments.length?(duration=e,t):"undefined"!=typeof duration?duration:500},t.edgeOpacity=function(e){return arguments.length?(g=e,t):"undefined"!=typeof g?g:.4},t.bars=function(e){function r(t,r){return"undefined"==typeof e||e.part===r||d[e.part](t)===e.key}function n(){var e=t.min()/2;s.primary.forEach(function(t){t.height<e&&(t.height=e)}),s.secondary.forEach(function(t){t.height<e&&(t.height=e)})}function a(e){function n(n){return r(n,e)?t.value()(n):0}var a=d3.nest().key("primary"==e?t.keyPrimary():t.keySecondary()).rollup(function(t){return d3.sum(t,n)}).entries(t.data()),i=o(a,t.pad(),t.min(),0,"vertical"==y?t.height():t.width()),u=t.barSize();a.forEach(function(r,n){s[e].push({x:"horizontal"==y?(i[n].s+i[n].e)/2:"primary"==e?u/2:t.width()-u/2,y:"vertical"==y?(i[n].s+i[n].e)/2:"primary"==e?u/2:t.height()-u/2,height:"vertical"==y?(i[n].e-i[n].s)/2:u/2,width:"horizontal"==y?(i[n].e-i[n].s)/2:u/2,part:e,key:r.key,value:r.value,percent:i[n].p})})}function i(e){function n(n){return r(n,e)?t.value()(n):0}var a=d3.map(s[e],function(t){return t.key}),i=d3.nest().key("primary"==e?t.keyPrimary():t.keySecondary()).key("secondary"==e?t.keyPrimary():t.keySecondary()).rollup(function(t){return d3.sum(t,n)}).entries(t.data());i.forEach(function(r){var n=a.get(r.key),i=o(r.values,0,0,"vertical"==y?n.y-n.height:n.x-n.width,"vertical"==y?n.y+n.height:n.x+n.width),u=t.barSize();r.values.forEach(function(a,o){c[e].push({x:"vertical"==y?"primary"==e?u/2:t.width()-u/2:(i[o].s+i[o].e)/2,y:"horizontal"==y?"primary"==e?u/2:t.height()-u/2:(i[o].s+i[o].e)/2,height:("vertical"==y?i[o].e-i[o].s:u)/2,width:("horizontal"==y?i[o].e-i[o].s:u)/2,part:e,primary:"primary"==e?r.key:a.key,secondary:"primary"==e?a.key:r.key,value:a.value,percent:i[o].p*n.percent,index:"primary"==e?r.key+"|"+a.key:a.key+"|"+r.key})})})}function u(){var t=d3.map(c.secondary,function(t){return t.index});return c.primary.map(function(e){var r=t.get(e.index);return{path:"vertical"===y?["M",e.x+e.width,",",e.y+e.height,"V",e.y-e.height,"L",r.x-r.width,",",r.y-r.height,"V",r.y+r.height,"Z"].join(""):["M",e.x-e.width,",",e.y+e.height,"H",e.x+e.width,"L",r.x+r.width,",",r.y-r.height,"H",r.x-r.width,"Z"].join(""),primary:e.primary,secondary:e.secondary,value:e.value,percent:e.percent}})}function o(t,e,r,n,a){var i=r/(a-n-2*t.length*e),u=0,o=0,s=d3.sum(t,function(t){return t.value});t.forEach(function(t){t.value<i*s&&(u+=1,o+=t.value)});var c=1e-5>s?0:(a-n-2*t.length*e-u*r)/(s-o),d=n,y=[];return t.forEach(function(t){var n=t.value*c;y.push({s:d+e+(r>n?.5*(r-n):0),e:d+e+(r>n?.5*(r+n):n),p:1e-5>s?0:t.value/s}),d+=2*e+(r>n?r:n)}),y}var s={primary:[],secondary:[]},c={primary:[],secondary:[]},d={primary:t.keyPrimary(),secondary:t.keySecondary()},y=t.orient();return a("primary"),a("secondary"),i("primary"),i("secondary"),n(),{mainBars:s.primary.concat(s.secondary),subBars:c.primary.concat(c.secondary),edges:u()}},t.mouseover=function(i){var u=t.bars(i);m.selectAll(".mainBars").filter(function(t){return t.part===i.part&&t.key===i.key}).select("rect").style("stroke-opacity",1),m.selectAll(".subBars").data(u.subBars).transition().duration(t.duration()).attr("transform",function(t){return"translate("+t.x+","+t.y+")"}).select("rect").attr("x",e).attr("y",r).attr("width",n).attr("height",a);var o=m.selectAll(".edges").data(u.edges);o.filter(function(t){return t[i.part]===i.key}).transition().duration(t.duration()).style("fill-opacity",.5).attr("d",function(t){return t.path}),o.filter(function(t){return t[i.part]!==i.key}).transition().duration(t.duration()).style("fill-opacity",0).attr("d",function(t){return t.path}),m.selectAll(".mainBars").data(u.mainBars).transition().duration(t.duration()).attr("transform",function(t){return"translate("+t.x+","+t.y+")"}).select("rect").attr("x",e).attr("y",r).attr("width",n).attr("height",a)},t.mouseout=function(i){var u=t.bars();m.selectAll(".mainBars").filter(function(t){return t.part===i.part&&t.key===i.key}).select("rect").style("stroke-opacity",0),m.selectAll(".subBars").data(u.subBars).transition().duration(t.duration()).attr("transform",function(t){return"translate("+t.x+","+t.y+")"}).select("rect").attr("x",e).attr("y",r).attr("width",n).attr("height",a),m.selectAll(".edges").data(u.edges).transition().duration(t.duration()).style("fill-opacity",t.edgeOpacity()).attr("d",function(t){return t.path}),m.selectAll(".mainBars").data(u.mainBars).transition().duration(t.duration()).attr("transform",function(t){return"translate("+t.x+","+t.y+")"}).select("rect").attr("x",e).attr("y",r).attr("width",n).attr("height",a)},t},this.viz=t}();